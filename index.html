<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>观象 - 全息动态增强版 (v1.3.0)</title>
    <style>
        :root { --body-bg: #FFFFFF; --paper-bg: #F5F2E9; --ink-black: #2D2926; --cinnabar: #8B0000; --border-old: #A6937C; }
        body { background-color: var(--body-bg); color: var(--ink-black); font-family: "STSong", "SimSun", serif; padding: 10px; display: flex; justify-content: center; margin: 0; }
        
        .container { max-width: 850px; width: 100%; background-color: var(--paper-bg); padding: 50px; border: 1px solid var(--border-old); position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        @media (max-width: 600px) {
            .container { padding: 30px 15px; }
            h1 { font-size: 1.8rem !important; letter-spacing: 8px !important; }
            .sensor-box, .input-row { grid-template-columns: 1fr !important; gap: 15px !important; }
            .gua-grid { grid-template-columns: 1fr !important; gap: 25px !important; }
            .advice-grid { grid-template-columns: 1fr !important; }
            .guide-box { padding-right: 35px !important; }
            .version-tag { left: 10px !important; top: 15px !important; font-size: 0.7rem !important; }
            .disclaimer { right: 10px !important; top: 15px !important; font-size: 0.75rem !important; }
        }
         
        .version-tag { position: absolute; top: 25px; left: 30px; font-size: 0.8rem; color: #BBB; font-weight: bold; writing-mode: vertical-rl; padding-right: 10px; border-right: 1px solid var(--border-old); letter-spacing: 2px; }
        .disclaimer { position: absolute; top: 25px; right: 30px; font-size: 0.9rem; color: #888; font-weight: bold; writing-mode: vertical-rl; padding-left: 10px; border-left: 1px solid var(--border-old); }
        
        h1 { text-align: center; color: var(--cinnabar); font-size: 2.5rem; letter-spacing: 15px; margin: 0 0 10px 0; }
        .header-stats { text-align: center; font-size: 0.85rem; color: #A6937C; letter-spacing: 2px; margin-bottom: 25px; font-style: italic; min-height: 1.2em; }
        
        .guide-box { background: rgba(255, 255, 255, 0.4); border: 1px dashed var(--border-old); padding: 20px; margin-bottom: 30px; }
        .guide-title { font-weight: bold; font-size: 1rem; color: var(--cinnabar); margin-bottom: 8px; display: block; }
        .guide-content { font-size: 0.9rem; color: #543; line-height: 1.8; }
        .must { color: var(--cinnabar); font-weight: bold; }

        .time-sync-bar { background: rgba(0,0,0,0.04); padding: 12px 20px; font-size: 0.9rem; margin-bottom: 25px; display: flex; justify-content: space-between; border-bottom: 1px solid #D8D0C0; }
        .sensor-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border-old); background: rgba(255,255,255,0.7); font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        
        button#btnRun { width: 100%; padding: 20px; background: var(--cinnabar); color: #FFF; border: none; font-size: 1.3rem; cursor: pointer; letter-spacing: 12px; transition: 0.3s; box-shadow: 0 4px 0 #600; }
        button#btnRun:active { transform: translateY(2px); box-shadow: 0 2px 0 #600; }

        #result { display: none; margin-top: 40px; border-top: 2px solid var(--cinnabar); padding-top: 30px; }
        .luck-tag { text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--cinnabar); letter-spacing: 6px; margin-bottom: 30px; line-height: 1.5; }
        
        .gua-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .gua-item { text-align: center; }
        .gua-box { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.6); padding: 25px 10px; border: 1px solid #EAE3D2; min-height: 140px; }
        .gua-meaning { font-size: 0.75rem; color: #765; margin-top: 8px; line-height: 1.4; padding: 0 5px; }
        
        .yao-wrapper { display: flex; align-items: center; margin: 4px 0; }
        .yao-label { font-size: 0.7rem; color: #999; width: 22px; text-align: right; margin-right: 8px; }
        .yao { width: 80px; height: 10px; background-color: var(--ink-black); position: relative; }
        .yao.yin { background: none; display: flex; justify-content: space-between; }
        .yao.yin::before, .yao.yin::after { content: ""; width: 36px; height: 10px; background-color: var(--ink-black); }
        .yao.moving-yao { background-color: var(--cinnabar); }
        .moving-dot { color: var(--cinnabar); position: absolute; right: -25px; font-size: 14px; top: -4px; }

        .advice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .advice-item { border-left: 4px solid var(--cinnabar); background: rgba(255,255,255,0.6); padding: 15px; }
        .advice-title { font-weight: bold; color: var(--cinnabar); display: block; margin-bottom: 8px; border-bottom: 1px solid #EEE; }
        
        .process-log { background: #1a1816; color: #B59F7A; padding: 25px; font-size: 0.85rem; line-height: 1.8; margin-top: 20px; border-radius: 4px; }
        .math-block { background: #262422; border-left: 4px solid var(--cinnabar); padding: 15px; margin-top: 12px; font-family: "Courier New", Courier, monospace; }
        .path-step { border-bottom: 1px solid #3d3a36; padding: 5px 0; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="version-tag">版本 v1.3.0 </div>
    <div class="disclaimer">梅花易数·观象推演·纯属娱乐·相信科学</div>
    <h1>观象</h1>
        
    <div class="guide-box">
        <span class="guide-title">观象指引：</span>
        <div class="guide-content">
            1. 静心：深呼吸三次，在心中默念你想要推测的事情。<br>
            2. <span class="must">【必填】感应参数</span>：1-100间的直觉数字。<br>
            3. 【选填】物感描述：输入景物描述可叠加能量扰动。<br>
            4. 【选填】时空校对：手动修正或由系统感应。
        </div>
    </div>

    <div class="time-sync-bar">
        <span>系统时间：<b id="sysTimeDisplay">--:--:--</b></span>
        <span>匹配时辰：<b id="autoZhiDisplay">--</b></span>
    </div>

    <div class="sensor-box">
        <div class="sensor-item">
            <label>见相定卦 (人物锁定)</label>
            <select id="personS">
                <option value="0">-- 自动推算 (高灵敏度数字起卦) --</option>
                <option value="1">乾-尊长/老父</option><option value="8">坤-老母/母亲</option>
                <option value="4">震-壮男/长男</option><option value="5">巽-长女/妇人</option>
                <option value="6">坎-中男/中年</option><option value="3">离-中女/中年</option>
                <option value="7">艮-少男/儿童</option><option value="2">兑-少女/幼女</option>
            </select>
        </div>
        <div class="sensor-item"><label>物感描述 (字感应)</label><input type="text" id="soundN" maxlength="10" placeholder="例: 窗外喜鹊叫"></div>
    </div>

    <div class="input-row">
        <div><label class="must">感应参数 (1-100) *</label><input type="number" id="inputVal" min="1" max="100" placeholder="数字敏感"></div>
        <div><label>感应方位 (空间)</label><select id="direction">
            <option value="0">未知/正中</option><option value="1">南-离</option><option value="2">西南-坤</option><option value="3">西-兑</option><option value="4">西北-乾</option><option value="5">北-坎</option><option value="6">东北-艮</option><option value="7">东-震</option><option value="8">东南-巽</option>
        </select></div>
        <div><label>时辰校正</label><select id="timeSelect">
            <option value="0">自动抓取</option><option value="1">子时</option><option value="2">丑时</option><option value="3">寅时</option><option value="4">卯时</option><option value="5">辰时</option><option value="6">巳时</option><option value="7">午时</option><option value="8">未时</option><option value="9">申时</option><option value="10">酉时</option><option value="11">戌时</option><option value="12">亥时</option>
        </select></div>
    </div>
    
    <button type="button" id="btnRun">开启全息推演</button>

    <div id="result">
        <div id="luckTag" class="luck-tag"></div>
        <div class="gua-grid">
            <div class="gua-item"><div class="gua-box" id="guaBen"></div><div id="nameBen" style="margin-top:10px;font-weight:bold;"></div><div id="meanBen" class="gua-meaning"></div><div style="font-size:0.8rem;color:#888;">本卦 (事之初)</div></div>
            <div class="gua-item"><div class="gua-box" id="guaHu"></div><div id="nameHu" style="margin-top:10px;font-weight:bold;"></div><div id="meanHu" class="gua-meaning"></div><div style="font-size:0.8rem;color:#888;">互卦 (事之中)</div></div>
            <div class="gua-item"><div class="gua-box" id="guaBian"></div><div id="nameBian" style="margin-top:10px;font-weight:bold;"></div><div id="meanBian" class="gua-meaning"></div><div style="font-size:0.8rem;color:#888;">变卦 (事之终)</div></div>
        </div>
        <div class="advice-grid" id="adviceGrid"></div>
        <div class="process-log" id="processLog"></div>
    </div>
</div>

<script>
    const GUA_DATA = { "乾":[1,1,1,"金","天","刚健中正，自强不息"], "兑":[0,1,1,"金","泽","喜悦随和，外柔内刚"], "离":[1,0,1,"火","火","光明美丽，附着向上"], "震":[1,0,0,"木","雷","奋起振作，动向明确"], "巽":[0,1,1,"木","风","谦逊渗透，顺从入理"], "坎":[0,1,0,"水","水","陷险防阻，心诚行远"], "艮":[0,0,1,"土","山","静止持重，适可而止"], "坤":[0,0,0,"土","地","厚德载物，柔顺包容"] };
    const GUA_LIST = ["坤", "乾", "兑", "离", "震", "巽", "坎", "艮", "坤"];
    const DI_ZHI = ["", "子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
    const DIR_VAL = [0, 3, 8, 2, 1, 6, 7, 4, 5];

    const GUA_NAME_MAP = {
        "离艮": "火山旅", "乾艮": "天山遁", "兑坤": "泽地萃", "震离": "雷火丰", "坎巽": "水风井", "坤震": "地雷复", "艮兑": "山泽损", "巽坎": "风水涣", "离乾": "火天大有", "乾离": "天火同人"
    };

    const JUDGMENTS_PRO = {
        "用生体": { tag: "亨", desc: "大吉。外力相助，顺水推舟。" },
        "比和": { tag: "贞", desc: "中吉。内外一致，平稳推进。" },
        "体克用": { tag: "利", desc: "小吉。克难成事，劳而有获。" },
        "体生用": { tag: "耗", desc: "平。付出过大，宜韬光养晦。" },
        "用克体": { tag: "厉", desc: "凶。压力临头，宜守不宜进。" }
    };

    const JUDGMENTS = {
        "用生体": { career: ["贵人垂青，谋事易成。宜积极进取。"], wealth: ["财源自来，无需苦求。"], love: ["对方情深意重，琴瑟和鸣。"], health: ["正气升腾，宿疾有痊愈之机。"] },
        "比和": { career: ["同道相谋，平稳发展。协作保万全。"], wealth: ["财运平稳，细水流长。"], love: ["志趣相投，沟通无碍。"], health: ["五行平衡，身心康泰。"] },
        "体克用": { career: ["劳心劳力，凭毅力终能掌控局面。"], wealth: ["利在险中求，波折但结局尚可。"], love: ["掌控欲较强，宜多换位思考。"], health: ["元气消耗快，注意劳逸结合。"] },
        "体生用": { career: ["虚耗过重，为他人作嫁衣。建议守成。"], wealth: ["钱财外泄，防范虚诈。"], love: ["付出难获对等回应，宜自爱。"], health: ["精气神偏弱，建议补益。"] },
        "用克体": { career: ["局势受困，阻碍重重。宜守不宜进。"], wealth: ["求财受阻，严禁投机。"], love: ["缘分薄弱，沟通易生龃龉。"], health: ["病邪侵扰，防患未然。"] }
    };

   

    function updateTime() {
        const now = new Date();
        const zhiIdx = (Math.floor((now.getHours() + 1) / 2) % 12) + 1;
        document.getElementById('sysTimeDisplay').innerText = now.toLocaleTimeString();
        document.getElementById('autoZhiDisplay').innerText = DI_ZHI[zhiIdx] + "时";
        return zhiIdx;
    }
    let currentAutoZhi = updateTime();
    setInterval(updateTime, 1000);

    function renderGua(containerId, yaos, moveIdx = -1) {
        const container = document.getElementById(containerId); container.innerHTML = '';
        for(let i = 5; i >= 0; i--) {
            const wrapper = document.createElement('div'); wrapper.className = 'yao-wrapper';
            const label = document.createElement('span'); label.className = 'yao-label'; label.innerText = ["初", "二", "三", "四", "五", "上"][i];
            const yao = document.createElement('div');
            yao.className = `yao ${yaos[i] === 1 ? 'yang' : 'yin'} ${i === moveIdx ? 'moving-yao' : ''}`;
            if(i === moveIdx) { const dot = document.createElement('span'); dot.className = 'moving-dot'; dot.innerText = '●'; yao.appendChild(dot); }
            wrapper.appendChild(label); wrapper.appendChild(yao); container.appendChild(wrapper);
        }
    }

    document.getElementById('btnRun').onclick = function() {
        // --- 1. 基础数据计算 (保持 1.2.5 版本的严谨性) ---
        const rawVal = document.getElementById('inputVal').value;
        if (!rawVal) { alert("请先输入感应数字。"); return; }
        const userNum = Number(rawVal);
        let textEnergy = 0;
        const userText = (document.getElementById('soundN').value || "").trim();
        for(let i=0; i<userText.length; i++) textEnergy += userText.charCodeAt(i);

        let amplifiedNum = (userNum * userNum) + (userNum * (userNum % 2 ? 7 : 13));
        let S = amplifiedNum + textEnergy;
        const P = parseInt(document.getElementById('personS').value) || 0;
        const L = parseInt(DIR_VAL[document.getElementById('direction').value]) || 0;
        const T = parseInt(document.getElementById('timeSelect').value) || currentAutoZhi;

        let upIdx = P > 0 ? P : (S % 8 || 8);
        let downIdx = ((S + T + L) % 8) || 8;
        let mIdx = (((S + T + L) % 6) || 6) - 1;

        const ti = GUA_LIST[upIdx], yong = GUA_LIST[downIdx];
        const ben = [...GUA_DATA[yong].slice(0,3), ...GUA_DATA[ti].slice(0,3)];
        const safeGet = (v) => Object.keys(GUA_DATA).find(k => GUA_DATA[k].slice(0,3).every((x,j) => x === v[j])) || "坤";
        const huU = safeGet([ben[2], ben[3], ben[4]]), huD = safeGet([ben[1], ben[2], ben[3]]);
        const hu = [...GUA_DATA[huD].slice(0,3), ...GUA_DATA[huU].slice(0,3)];
        let bian = [...ben]; bian[mIdx] = (ben[mIdx] === 1 ? 0 : 1);
        const yB = safeGet(bian.slice(0,3)), tB = safeGet(bian.slice(3,6));

        // --- 2. 卦名与格局判定 ---
        const nameBen = GUA_NAME_MAP[ti + yong] || (ti + yong);
        const nameHu = GUA_NAME_MAP[huU + huD] || (huU + huD);
        const nameBian = GUA_NAME_MAP[tB + yB] || (tB + yB);
        const rules = {"木":{"生":"火","克":"土"},"火":{"生":"土","克":"金"},"土":{"生":"金","克":"水"},"金":{"生":"水","克":"木"},"水":{"生":"木","克":"火"}};
        const getRel = (t, y) => (t===y)?"比和":(rules[y]?.生===t?"用生体":(rules[y]?.克===t?"用克体":(rules[t]?.生===y?"体生用":"体克用")));
        let relBen = getRel(ti, yong);
        const pInfo = JUDGMENTS_PRO[relBen];
        const ctx = JUDGMENTS[relBen];

        // --- 3. 深度缝合：全流程逻辑注入 ---
        // 事业：本卦看象，互卦看变数
        const careerFinal = `${ctx.career[0]} 此事起于[${nameBen}]之象，中途受[${nameHu}]干扰，务必保持定力，方能达成[${nameBian}]之终局。`;
        
        // 钱财：以变卦为归宿
        const wealthFinal = `财气自[${nameBen}]萌发，${ctx.wealth[0]} 过程见[${nameHu}]之虚耗或转机，利在[${nameBian}]所指之方。`;
        
        // 姻缘：【新增融合】现状、纠葛、归宿
        const loveFinal = `情缘现状如[${nameBen}]般${GUA_DATA[ti][5].split('，')[0]}。${ctx.love[0]} 虽有[${nameHu}]之纠缠或隐忧，然终将落定于[${nameBian}]，宜顺应天时。`;
        
        // 健康：【新增融合】病机与预后
        const healthFinal = `当下体察[${nameBen}]之气，${GUA_DATA[ti][4]}象偏旺。${ctx.health[0]} 注意[${nameHu}]提示的隐性病灶，预后则看[${nameBian}]之平衡。`;

        // --- 4. 渲染界面 ---
        document.getElementById('result').style.display = 'block';
        renderGua('guaBen', ben, mIdx); renderGua('guaHu', hu); renderGua('guaBian', bian);
        document.getElementById('nameBen').innerText = nameBen;
        document.getElementById('nameHu').innerText = nameHu;
        document.getElementById('nameBian').innerText = nameBian;
        document.getElementById('meanBen').innerText = GUA_DATA[ti][5];
        document.getElementById('meanHu').innerText = GUA_DATA[huU][5];
        document.getElementById('meanBian').innerText = GUA_DATA[tB][5];

        document.getElementById('luckTag').innerHTML = `断曰：[${nameBen}] · <span style="color:var(--cinnabar)">${pInfo.tag}</span><br><small style="font-weight:normal;color:#666;">${pInfo.desc}</small>`;

        document.getElementById('adviceGrid').innerHTML = `
            <div class="advice-item"><span class="advice-title">■ 事业功名</span><div>${careerFinal}</div></div>
            <div class="advice-item"><span class="advice-title">■ 钱财求利</span><div>${wealthFinal}</div></div>
            <div class="advice-item"><span class="advice-title">■ 姻缘情感</span><div>${loveFinal}</div></div>
            <div class="advice-item"><span class="advice-title">■ 健康疾厄</span><div>${healthFinal}</div></div>`;

        document.getElementById('processLog').innerHTML = `
            <span style="color:#B59F7A; font-weight:bold; display:block; text-align:center;">全息路径推演 (v1.2.9 缝合增强版)</span>
            <div class="math-block">
                <span class="path-step">① 初始能量：基数 S = ${S}</span>
                <span class="path-step">② 动态演化：[${nameBen}] (初) ➔ [${nameHu}] (中) ➔ [${nameBian}] (终)</span>
                <span class="path-step">③ 五行定格：体卦【${ti}】(${GUA_DATA[ti][3]}) 对 用卦【${yong}】(${GUA_DATA[yong][3]})，呈【${relBen}】之势。</span>
            </div>`;
        document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
    };
</script>
</body>
</html>

